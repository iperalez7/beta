<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Warehouse Tasks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#2196f3">
  <!-- Link to manifest.json for PWA capability -->
  <link rel="manifest" href="/manifest.json">
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f2f5f8; }
    header { background:#2196f3; color:white; padding:1em; font-size:1.4em; text-align:center; position:sticky; top:0; }
    .notif-btn, .notif-status {
      position: absolute; right:1em; top:1em;
      background: #fff; color: #2196f3;
      border: none; border-radius: 30px; padding: .3em 1.2em; font-size: 1em;
      font-weight: bold; box-shadow: 0 2px 8px #0001; cursor: pointer;
    }
    .notif-status { right:7em; background:#e3f2fd; color:#2196f3; }
    #notif-banner {
      display:none; background:#ffeb3b; color:#222; text-align:center; padding:.7em; font-size:1.1em;
    }
    .task-list { padding:1em; }
    .task {
      background:#fff; margin:.7em 0; padding:1em; border-radius:8px;
      box-shadow:0 2px 4px #0001;
      display:flex; flex-direction: column;
    }
  </style>
</head>
<body>
  <header>
    Warehouse Tasks
    <span id="notif-status" class="notif-status"></span>
    <button id="notif-btn" class="notif-btn">ðŸ”” Enable Notifications</button>
  </header>
  <div id="notif-banner">Enable notifications for live task alerts! Install app to your Home Screen and accept notification permissions.</div>
  <main>
    <div class="task-list" id="tasks"></div>
    <button style="margin:2em auto;display:block;font-size:1.2em; padding:.5em 2em;" onclick="addFakeTask()">Add Sample Task (Demo)</button>
  </main>
  <script>
    // --- PWA Service Worker registration ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => {
            //console.log('SW registered:', reg.scope);
          }, err => {
            //console.warn('SW reg failed:', err);
          });
      });
    }

    // -- Notification Permission UI --
    const notifBtn   = document.getElementById('notif-btn');
    const notifStat  = document.getElementById('notif-status');
    const notifBanner= document.getElementById('notif-banner');

    function refreshNotifUI() {
      if (!('Notification' in window)) {
        notifBtn.style.display = 'none';
        notifStat.style.display = 'inline';
        notifStat.textContent = "Notifications Not Supported";
        notifBanner.style.display='block';
        return;
      }
      switch (Notification.permission) {
        case 'granted':
          notifBtn.style.display='none';
          notifStat.style.display='inline';
          notifStat.textContent = "ðŸ”” On";
          notifBanner.style.display='none';
          break;
        case 'denied':
          notifBtn.style.display='none';
          notifStat.style.display='inline';
          notifStat.textContent = "ðŸ”• Blocked";
          notifBanner.textContent="Notifications are blocked in settings. Please re-enable in iOS settings > Notifications.";
          notifBanner.style.display='block';
          break;
        default:
          notifBtn.style.display='inline';
          notifStat.style.display='none';
          notifBanner.style.display='block';
      }
    }

    notifBtn.onclick = function() {
      if (!('Notification' in window)) {
        notifBanner.style.display='block';
        return;
      }
      Notification.requestPermission()
      .then(perm => {
        refreshNotifUI();
        if (perm === "granted") {
          sendLocalTestNotification();
        }
      });
    };

    // Fake Local Notification for demo -- native Push will require server-side
    function sendLocalTestNotification(msg) {
      if (Notification.permission === "granted") {
        navigator.serviceWorker.getRegistration().then(rg=>{
          if (rg) {
            rg.showNotification("Warehouse Test", {
              body: msg || "Notifications are working!"
            });
          }
        });
      }
    }

    // --- Main App Logic Demo: Display tasks, notify on new task ---
    let taskIdSeq = 1;

    function addTask(task) {
      const list = document.getElementById('tasks');
      const d = document.createElement('div');
      d.className = "task";
      d.innerHTML = `<b>${task.title}</b><br>Status: ${task.status}<br><small>${task.details}</small>`;
      list.insertBefore(d, list.firstChild);

      // Show notification if permitted
      if (Notification.permission === "granted") {
        navigator.serviceWorker.getRegistration().then(swreg=>{
          if (!swreg) return;
          swreg.showNotification("New Warehouse Task", {
            body: `${task.title}: ${task.details}`
          });
        });
      }
    }

    // Demo: Add a fake task for test
    window.addFakeTask = function() {
      const task = {
        title: "Task #" + (taskIdSeq++),
        status: "New",
        details: "Demo operation item created at " + new Date().toLocaleTimeString()
      };
      addTask(task);
    };

    // Refresh UI on load & when permission changes
    refreshNotifUI();

    // iOS: Hint to the user on first launch
    setTimeout(()=>{if(Notification.permission!=="granted") notifBanner.style.display='block';},4000);
  </script>
</body>
</html>